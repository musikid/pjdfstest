<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Declaration - PJDFSTest</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">Running tests</li><li class="chapter-item expanded "><a href="getting-started.html"><strong aria-hidden="true">1.</strong> Getting started</a></li><li class="chapter-item expanded "><a href="compatibility.html"><strong aria-hidden="true">2.</strong> Compatibility</a></li><li class="chapter-item expanded "><a href="configuration-file.html"><strong aria-hidden="true">3.</strong> Configuration file</a></li><li class="chapter-item expanded affix "><li class="part-title">Writing tests</li><li class="chapter-item expanded "><a href="tests-structure.html"><strong aria-hidden="true">4.</strong> Structure</a></li><li class="chapter-item expanded "><a href="test-declaration.html" class="active"><strong aria-hidden="true">5.</strong> Declaration</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">PJDFSTest</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/saidsay-so/pjdfstest" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="test-declaration"><a class="header" href="#test-declaration">Test declaration</a></h1>
<p>Test cases have the same structure than usual Rust tests,
that is <code>unwrap</code>ing <code>Result</code>s and using assertion macros (<code>assert</code> and <code>assert_eq</code>),
the exception being that it should take a <code>&amp;mut TestContext</code> parameter.
It might also take a <code>FileType</code> argument if required.
It also needs an additional declaration with the <code>test_case!</code> macro alongside the function,
with the function name being the only mandatory argument.</p>
<p>For example:</p>
<pre><code class="language-rust ignore">// chmod/00.t:L58
crate::test_case! {
    /// chmod updates ctime when it succeeds
    update_ctime =&gt; [Regular, Dir, Fifo, Block, Char, Socket]
}
fn update_ctime(ctx: &amp;mut TestContext, f_type: FileType) {
    let path = ctx.create(f_type).unwrap();
    assert_ctime_changed(ctx, &amp;path, || {
        assert!(chmod(&amp;path, Mode::from_bits_truncate(0o111)).is_ok());
    });
}</code></pre>
<p>All the structures and functions needed are documented in the <code>pjdfstest</code> crate,
which you can obtain by running <code>cargo doc --open</code> in the <code>rust</code> directory
or by visiting the <a href="doc/pjdfstest/">documentation</a>.</p>
<h2 id="test-context"><a class="header" href="#test-context">Test context</a></h2>
<p>The <a href="doc/pjdfstest/context/struct.TestContext.html"><code>TestContext</code></a>
struct is a helper struct which provides methods to create files,
sleep, change user, etc.
It is passed as a parameter to the test functions and should be used
to interact with the system in order to ensure that the tests are isolated
and do not interfere with each other.</p>
<h3 id="serialization"><a class="header" href="#serialization">Serialization</a></h3>
<p>When a test case needs to be run in a serialized manner, the
<a href="doc/pjdfstest/context/struct.SerializedTestContext.html"><code>SerializedTestContext</code></a>
struct should be used instead.
It provides additional methods to change the user, group,
supplementary groups, or umask of the process.
Please see the <a href="#serialized-test-cases">Serialized test cases</a> section for more information.</p>
<h2 id="assertions"><a class="header" href="#assertions">Assertions</a></h2>
<p>The <code>assert</code> and <code>assert_eq</code> macros should be used to check the results of the tests.
The <code>assert</code> macro should be used when the test is checking a condition,
while the <code>assert_eq</code> macro should be used when the test is checking
that two values are equal.
In addition to these macros, the suite provides some additional assertion functions which
should be used when appropriate.
The tests <a href="doc/pjdfstest/tests/index.html#functions">module</a> documentation provides
a list of these functions.</p>
<h2 id="description"><a class="header" href="#description">Description</a></h2>
<p>It is possible to provide doc comments which will be used as documentation for developers
but also be displayed to users when they run the test.
The doc comments should be written in the <code>test_case!</code> declaration, before anything.
For example:</p>
<pre><code class="language-rust ignore">crate::test_case! {
    /// The file mode of a newly created file should not affect whether
    /// posix_fallocate will work, only the create args
    /// https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=154873
    affected_only_create_flags, serialized, root, FileSystemFeature::PosixFallocate
}</code></pre>
<h2 id="parameterization"><a class="header" href="#parameterization">Parameterization</a></h2>
<p>It is possible to give additional parameters to the test case macro,
to modify the execution of the tests or add requirements.</p>
<h3 id="file-system-exclusive-features"><a class="header" href="#file-system-exclusive-features">File-system exclusive features</a></h3>
<p>Some features are not available for every file system.
For tests requiring such features, the execution becomes opt-in.
A variant of the <code>FileSystemFeature</code> enum corresponding to this feature
should be specified after potential <code>root</code> requirement and before guards.
Multiple features can be specified, separated by a comma <code>,</code>.</p>
<p>For example:</p>
<pre><code class="language-rust ignore">#[cfg(target_os = "freebsd")]
crate::test_case! {eperm_immutable_flag, FileSystemFeature::Chflags, FileSystemFeature::PosixFallocate ...}</code></pre>
<h4 id="adding-features"><a class="header" href="#adding-features">Adding features</a></h4>
<p>New features can be added to the <code>FileSystemFeature</code> enum.
A description of the feature should be provided as documentation
for both developers and users.</p>
<h3 id="guards"><a class="header" href="#guards">Guards</a></h3>
<p>It is possible to specify "guards", which are functions which checks if a requirement
is met and return an error if not so the test will be skipped.
They can be specified by appending function names after a <code>;</code> separator,
after potential <code>root</code> requirement and features.</p>
<p>The function has to take a <code>&amp;Config</code> argument
which contains the current configuration
and a <code>&amp;Path</code> which represents the parent folder
of the potential test context which would be created.</p>
<h4 id="guard-signature"><a class="header" href="#guard-signature">Guard signature</a></h4>
<pre><code class="language-rust ignore">/// Function which indicates if the test should be skipped by returning an error.
pub type Guard = fn(&amp;Config, &amp;Path) -&gt; anyhow::Result&lt;()&gt;;</code></pre>
<h4 id="example"><a class="header" href="#example">Example</a></h4>
<pre><code class="language-rust ignore">fn has_reasonable_link_max(_: &amp;Config, base_path: &amp;Path) -&gt; anyhow::Result&lt;()&gt; {
    let link_max = pathconf(base_path, nix::unistd::PathconfVar::LINK_MAX)?
        .ok_or_else(|| anyhow::anyhow!("Failed to get LINK_MAX value"))?;

    if link_max &gt;= LINK_MAX_LIMIT {
        anyhow::bail!("LINK_MAX value is too high ({link_max}, expected smaller than {LINK_MAX_LIMIT}");
    }

    Ok(())
}

crate::test_case! {
    /// link returns EMLINK if the link count of the file named by name1 would exceed {LINK_MAX}
    link_count_max; has_reasonable_link_max
}
...</code></pre>
<h3 id="root-privileges"><a class="header" href="#root-privileges">Root privileges</a></h3>
<p>Some tests may need root privileges to run.
To declare that a test function require such privileges,
<code>root</code> should be added to its declaration.
For example:</p>
<pre><code class="language-rust ignore">crate::test_case!{change_perm, root}</code></pre>
<p>The root requirement is automatically added for privileged file types,
namely block and char.</p>
<h3 id="file-types"><a class="header" href="#file-types">File types</a></h3>
<p>Some test cases need to test over different file types.
The file types should be added at the end of the test case declaration,
within brackets and with a fat arrow before (<code>=&gt; [Regular]</code>).
The test function should also accept a <code>FileType</code> parameter to operate on.</p>
<p>For example:</p>
<pre><code class="language-rust ignore">crate::test_case! {change_perm, root, FileSystemFeature::Chflags =&gt; [Regular, Fifo, Block, Char, Socket]}
fn change_perm(ctx: &amp;mut TestContext, f_type: FileType) {</code></pre>
<h2 id="platform-specific-features"><a class="header" href="#platform-specific-features">Platform-specific features</a></h2>
<p>Some features (like <code>lchmod</code>) are not supported on every operating system.
When a test make use of such feature, it is possible to restrain its compilation
to the supported operating systems, with the attribute <code>#[cfg(feature_name)]</code>.
It is also possible to apply this attribute on an aspect or even a syscall module.
For example:</p>
<pre><code class="language-rust ignore">#[cfg(lchmod)]
mod lchmod;</code></pre>
<p>To declare it, the feature and its requirements have to be specified in the <code>build.rs</code> file
using the usual conditional compilation
<a href="https://doc.rust-lang.org/reference/conditional-compilation.html">syntax</a>.
Then, the feature should be added to the <code>cfg_aliases!</code> macro.
With <code>lchmod</code>, we would get:</p>
<pre><code class="language-rust ignore">    cfg_aliases! {
        ...
        lchmod: { any(target_os = "netbsd", target_os = "freebsd", target_os = "dragonfly") },
        ...
    }</code></pre>
<h2 id="serialized-test-cases"><a class="header" href="#serialized-test-cases">Serialized test cases</a></h2>
<p>Some test cases need functions only available when they are run serialized,
especially when they affect the whole process.
An example is changing user (<code>SerializedTestContext::as_user</code>).
To have access to these functions, the test should be declared with a
<a href="doc/pjdfstest/context/struct.SerializedTestContext.html"><code>SerializedTestContext</code></a>
parameter in place of <code>TestContext</code> and the <code>serialized</code> keyword
should be prepended before features and <code>root</code> requirement.</p>
<p>For example:</p>
<pre><code class="language-rust ignore">crate::test_case! {
    /// link changes neither ctime of file nor ctime or mtime of parent when it fails
    // link/00.t#77
    unchanged_ctime_fails, serialized, root =&gt; [Regular, Fifo, Block, Char, Socket]
}
fn unchanged_ctime_fails(ctx: &amp;mut SerializedTestContext, ft: FileType) {
    let file = ctx.create(ft).unwrap();
    let new_path = ctx.gen_path();

    let user = ctx.get_new_user();
    assert_times_unchanged()
        .path(&amp;file, CTIME)
        .path(ctx.base_path(), CTIME | MTIME)
        .execute(ctx, false, || {
            ctx.as_user(user, None, || {
                assert!(matches!(
                    link(&amp;file, &amp;new_path),
                    Err(Errno::EPERM | Errno::EACCES)
                ));
            })
        });
}</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="tests-structure.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="tests-structure.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="mermaid.min.js"></script>
        <script src="mermaid-init.js"></script>


    </div>
    </body>
</html>
