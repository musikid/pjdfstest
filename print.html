<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>PJDFSTest</title>
        <meta name="robots" content="noindex" />
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">Running</li><li class="chapter-item expanded "><a href="configuration-file.html"><strong aria-hidden="true">1.</strong> Configuration file</a></li><li class="chapter-item expanded affix "><li class="part-title">Writing tests</li><li class="chapter-item expanded "><a href="tests-structure.html"><strong aria-hidden="true">2.</strong> Structure</a></li><li class="chapter-item expanded "><a href="test-declaration.html"><strong aria-hidden="true">3.</strong> Declaration</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">PJDFSTest</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p>PJDFSTest is a file system test suite.
It was originally written to validate the ZFS port to FreeBSD,
but it now supports multiple operating systems and file systems.
This is a complete rewrite of the original test suite in Rust.</p>
<h3 id="note-the-documentation-is-still-a-work-in-progress"><a class="header" href="#note-the-documentation-is-still-a-work-in-progress">NOTE: The documentation is still a work-in-progress.</a></h3>
<h2 id="build"><a class="header" href="#build">Build</a></h2>
<pre><code class="language-bash">cd rust
cargo run
</code></pre>
<h3 id="run-as-root"><a class="header" href="#run-as-root">Run as root</a></h3>
<pre><code class="language-bash">cd rust
cargo build &amp;&amp; sudo ./target/debug/pjdfs_runner
</code></pre>
<h2 id="architecture"><a class="header" href="#architecture">Architecture</a></h2>
<p>The package is made of the tests, and a test runner to launch them.</p>
<h3 id="tests-tests"><a class="header" href="#tests-tests">Tests (tests/)</a></h3>
<p>To present how tests are organized, we take the <code>chmod</code> syscall as example.</p>
<p>There is a separate module for each syscall being tested.  Within each of those
modules, there may be either a single file, or a separate file for each aspect
of the syscall.</p>
<p>The hierarchy is like this:</p>
<pre class="mermaid">graph TD
TG[Syscall module&lt;br /&gt;&lt;i&gt;chmod&lt;/i&gt;] --&gt; TC1[Aspect&lt;br /&gt;&lt;i&gt;errno&lt;/i&gt;]

TC1 --&gt; TC1F1[Test case]
TC1 --&gt; TC1F2[Test case]
TC1 --&gt; TC1F3[Test case]
TC1 --&gt; TC1F4[Test case]

TG --&gt; TC2[Aspect&lt;br /&gt;&lt;i&gt;permission&lt;/i&gt;]

TC2 --&gt; TC2F1[Test case]
TC2 --&gt; TC2F2[Test case]
</pre>
<h3 id="layout"><a class="header" href="#layout">Layout</a></h3>
<pre><code>src/tests
├── chmod (syscall)
│   ├── errno.rs (aspect)
│   ├── mod.rs (syscall declaration)
│   └── permission.rs (aspect)
└── mod.rs (glues syscalls together)
</code></pre>
<h4 id="testsmodrs"><a class="header" href="#testsmodrs">tests/mod.rs</a></h4>
<p>All the modules for the test groups should be declared in this file.</p>
<pre><code class="language-rust ignore">pub mod chmod;
</code></pre>
<h4 id="syscall-module"><a class="header" href="#syscall-module">Syscall module</a></h4>
<p>A syscall module contains test cases related to a specific syscall.
Its declaration should be in the <code>mod.rs</code> file 
of the relevant folder (<code>chmod/</code> in our case).
Common syscall-specific helpers can go here.</p>
<h3 id="aspect"><a class="header" href="#aspect">Aspect</a></h3>
<p>An optional aspect module contains test cases that all relate to a common
aspect of the syscall.
Here &quot;aspect&quot; is a subjective area of related functionality.
The aspect module may be either:</p>
<ul>
<li>in a single file, which contains all the test functions and the case declaration,</li>
<li>in a folder, which contains multiple modules for the test functions and a <code>mod.rs</code> file, in which the case is declared.</li>
</ul>
<p>Except in the case of a very large set of test functions, the first style
should be preferred.</p>
<h4 id="test-case"><a class="header" href="#test-case">Test case</a></h4>
<p>Each test case exercises a minimal piece of the syscall's functionality.
Each must be registered with the <code>test_case!</code> macro.</p>
<p>For now, the test function takes a <code>&amp;mut TestContext</code> parameter.</p>
<pre><code class="language-rust ignore">// chmod/00.t:L58
crate::test_case!{ctime, Syscall::Chmod}
fn ctime(ctx: &amp;mut TestContext) {
    for f_type in FileType::iter().filter(|ft| *ft != FileType::Symlink(None)) {
        let path = ctx.create(f_type).unwrap();
        let ctime_before = stat(&amp;path).unwrap().st_ctime;

        sleep(Duration::from_secs(1));

        chmod(&amp;path, Mode::from_bits_truncate(0o111)).unwrap();

        let ctime_after = stat(&amp;path).unwrap().st_ctime;
        assert!(ctime_after &gt; ctime_before);
    }
}
</code></pre>
<h3 id="test-runner-mainrs"><a class="header" href="#test-runner-mainrs">Test runner (main.rs)</a></h3>
<p>The test runner has to run the tests, and provide a command-line interface to allow the user to modify how the tests should be run.
It takes the tests from the specified test groups.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="configuration-file"><a class="header" href="#configuration-file">Configuration file</a></h1>
<p>The test runner can read a configuration file. For now, only the TOML format is supported.
Its path can be specified by using the <code>-c PATH</code> flag.</p>
<h2 id="sections"><a class="header" href="#sections">Sections</a></h2>
<h3 id="features"><a class="header" href="#features">[features]</a></h3>
<p>Some syscalls cannot be run on all combinations of file systems/platforms.
Their execution is opt-in,
as in the user should enable them by adding the key in this section.
A list of these opt-in groups should be provided 
when executing the runner with <code>-l</code> argument.</p>
<pre><code class="language-toml">[features]
posix_fallocate = {}

# Can also be specified by using key notation
[features.posix_fallocate]
</code></pre>
<h4 id="feature-configuration"><a class="header" href="#feature-configuration">Feature configuration</a></h4>
<p>TODO</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="structure"><a class="header" href="#structure">Structure</a></h1>
<p>The tests should be grouped by syscalls, in the <code>tests/</code> folder.
Each folder then have a <code>mod.rs</code> file, 
which contains declarations of the modules inside this folder,
and a <code>group!</code> statement to export the test cases from these modules.
For example:</p>
<h3 id="layout-1"><a class="header" href="#layout-1">Layout</a></h3>
<pre><code>chmod (syscall/test group)
├── errno.rs (test case)
├── mod.rs (test group declaration)
└── permission.rs (test case)
</code></pre>
<h3 id="modrs"><a class="header" href="#modrs">mod.rs</a></h3>
<pre><code class="language-rust ignore">mod permission;
mod lchmod;
</code></pre>
<p>Each module inside a group should register its test cases with <code>test_case!</code>.
In our example, <code>chmod/permission.rs</code> would be:</p>
<pre><code class="language-rust ignore">test_case!{ctime, root, Syscall::Chmod}
use crate::{
    test_case,
    test::{TestContext, TestResult},
};

// chmod/00.t:L58
fn ctime(ctx: &amp;mut TestContext) -&gt; TestResult {
  for f_type in FileType::iter().filter(|&amp;ft| ft == FileType::Symlink) {
      let path = ctx.create(f_type).map_err(TestError::CreateFile)?;
      let ctime_before = stat(&amp;path)?.st_ctime;

      sleep(Duration::from_secs(1));

      chmod(&amp;path, Mode::from_bits_truncate(0o111))?;

      let ctime_after = stat(&amp;path)?.st_ctime;
      test_assert!(ctime_after &gt; ctime_before);
  }

  Ok(())
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="test-declaration"><a class="header" href="#test-declaration">Test declaration</a></h1>
<p>Test cases have the same anatomy than usual Rust tests, 
that is <code>unwrap</code>ing <code>Result</code>s and using assertion macros (<code>assert</code> and <code>assert_eq</code>),
the exception being that it should take a <code>&amp;mut TestContext</code> parameter.
It might also take a <code>FileType</code> argument if required.
It also needs an additional declaration with the <code>test_case!</code> macro alongside the function, 
with the function name being the only mandatory argument.</p>
<p>For example:</p>
<pre><code class="language-rust ignore">// chmod/00.t:L58
crate::test_case! {ctime =&gt; [FileType::Regular, FileType::Fifo, FileType::Block, FileType::Char, FileType::Socket]}
fn ctime(ctx: &amp;mut TestContext, f_type: FileType) {
    let path = ctx.create(f_type).unwrap();
    let ctime_before = stat(&amp;path).unwrap().st_ctime;

    sleep(Duration::from_secs(1));

    chmod(&amp;path, Mode::from_bits_truncate(0o111)).unwrap();

    let ctime_after = stat(&amp;path).unwrap().st_ctime;
    assert!(ctime_after &gt; ctime_before);
}
</code></pre>
<h2 id="parameterization"><a class="header" href="#parameterization">Parameterization</a></h2>
<h3 id="file-types"><a class="header" href="#file-types">File types</a></h3>
<p>Some test cases need to test over different file types.
The file types should be added at the end of the test case declaration,
with brackets and an fat arrow before (<code>=&gt; [FileType::Regular]</code>).
The test function should also accept a <code>FileType</code> parameter to operate on.</p>
<p>For example:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>crate::test_case! {change_perm =&gt; [FileType::Regular, FileType::Fifo, FileType::Block, FileType::Char, FileType::Socket]}
fn change_perm(ctx: &amp;mut TestContext, f_type: FileType) {
<span class="boring">}
</span></code></pre></pre>
<h3 id="root-privileges"><a class="header" href="#root-privileges">Root privileges</a></h3>
<p>Some tests may need root privileges to run.
To declare that a test function require root privileges, 
<code>root</code> should be added to its declaration.
For example:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>crate::test_case!{change_perm, root}
<span class="boring">}
</span></code></pre></pre>
<p>The root requirement is automatically added for privileged file types,
namely block and char.</p>
<h2 id="platform-specific-functions"><a class="header" href="#platform-specific-functions">Platform-specific functions</a></h2>
<p>Some functions (like <code>lchmod</code>) are not supported on every operating system.
When a test make use of such function, it is possible to restrain its compilation
to the supported operating systems, with the attribute <code>#[cfg(target_os = ...)]</code>.
It is also possible to apply this attribute on an aspect, or even on a syscall module.
For example:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[cfg(target_os = &quot;freebsd&quot;)]
mod lchmod;
<span class="boring">}
</span></code></pre></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="mermaid.min.js"></script>
        <script type="text/javascript" src="mermaid-init.js"></script>
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
    </body>
</html>
